#!/usr/bin/env python
###########################################
## ellcurves
###########################################

import os, shutil, tempfile

if 'SAGE_DATA' not in os.environ:
    raise RuntimeError("SAGE_DATA undefined, maybe run 'sage -sh'?")

target=os.path.join(os.environ['SAGE_DATA'], 'ellcurves')
if os.path.exists(target):
    try:
        shutil.rmtree(target)
    except OSError:
        os.remove(target)

shutil.move('src', target)
rank = {}
for line in file(os.path.join(os.environ['COMMON_CURVES'], 'src', \
        'allcurves.00000-09999')).xreadlines():
    r = line.split()[4]
    if r not in rank:
        rank[r] = file(tempfile.mkstemp()[1], 'w')
    rank[r].write(line)

for r,f in rank.iteritems():
    f.close()
    endpath = os.path.join(target, 'rank'+r)
    if os.path.exists(endpath):
        old = tempfile.mkstemp()[1]
        shutil.move(endpath, old)
        shutil.move(f.name, endpath)
        f = file(endpath, 'a')
        tmp = file(old, 'r')
        f.write(tmp.read())
        tmp.close()
        f.close()
        os.remove(old)
    else:
        shutil.move(f.name, endpath)
