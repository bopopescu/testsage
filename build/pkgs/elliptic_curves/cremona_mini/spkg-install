#!/usr/bin/env python
###########################################
## cremona_mini
###########################################

from sqlite3 import connect
import os

if 'SAGE_DATA' not in os.environ:
    raise RuntimeError("SAGE_DATA undefined, maybe run 'sage -sh'?")

cremona_root=os.path.join(os.environ['SAGE_DATA'], 'cremona')
if not os.path.exists(cremona_root):
    os.makedirs(cremona_root)

target=os.path.join(cremona_root, 'cremona_mini.db')

if os.path.exists(target):
    os.remove(target)

con = connect(target)

con.execute('CREATE TABLE t_class(rank INTEGER, class TEXT PRIMARY KEY, conductor INTEGER)')
con.execute('CREATE TABLE t_curve(curve TEXT PRIMARY KEY, class TEXT, tors INTEGER, eqn TEXT UNIQUE)')
con.execute('CREATE INDEX i_t_class_conductor ON t_class(conductor)')
con.execute('CREATE INDEX i_t_curve_class ON t_curve(class)')

class_data = []
curve_data = []

for line in file(os.path.join(os.environ['COMMON_CURVES'], 'src', \
        'allcurves.00000-09999')).xreadlines():
    N, iso, num, eqn, r, tors = line.split()
    cls = N+iso
    cur = cls+num
    if num == "1":
        class_data.append((N,cls,r))
    curve_data.append((cur,cls,eqn,tors))

con.executemany('INSERT INTO t_class(conductor,class,rank) VALUES (?,?,?)', class_data)
con.executemany('INSERT INTO t_curve(curve,class,eqn,tors) VALUES (?,?,?,?)', curve_data)

con.commit()
