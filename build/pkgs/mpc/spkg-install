#!/usr/bin/env bash

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

# Unset RM since it messes with libtool
unset RM

# Cleaning
echo "Deleting old libraries"
rm -f "$SAGE_LOCAL"/lib/libmpc.*
echo "Deleting old headers"
rm -f "$SAGE_LOCAL"/include/mpc.h

cd src

# Setting up flags
if [ "x$SAGE64" = "xyes" ]; then
    echo "64 bit build"
    CFLAGS="-O2 -g -m64 "; export CFLAGS
    CXXFLAGS="-O2 -g -m64 "; export CXXFLAGS
    CPPFLAGS="-O2 -g -m64 "; export CPPFLAGS
fi

EXTRA=""

if [ ! -f "$SAGE_LOCAL/include/gmp.h" ]; then
    EXTRA="--disable-static --enable-shared"
fi

if [ $UNAME = "CYGWIN" ]; then
    EXTRA="--disable-static --enable-shared"
fi

# Configuring
./configure --prefix="$SAGE_LOCAL" --with-gmp="$SAGE_LOCAL" \
    --with-mpfr="$SAGE_LOCAL" CFLAGS="$CFLAGS $SHAREDFLAGS -O2" CXX="$CXX" \
    CXXFLAGS="$CXXFLAGS $SHAREDFLAGS" LDFLAGS="$LDFLAGS" \
    GMP_PREFIX="$SAGE_LOCAL" $EXTRA
if [ $? -ne 0 ]; then
   echo "Error configuring MPC."
   exit 1
fi

# Building
$MAKE
if [ $? -ne 0 ]; then
   echo "Error building MPC."
   exit 1
fi

# Installing
$MAKE install
if [ $? -ne 0 ]; then
   echo "Error installing MPC."
   exit 1
fi

# Final test
if ! [ -f $SAGE_LOCAL/include/mpc.h ];  then
    echo "An error occurred while building mpc."
    exit 1
fi
