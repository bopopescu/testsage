#!/usr/bin/env bash
###########################################
## Readline 5.2
###########################################

if [ "$SAGE_LOCAL" = "" ]; then
   echo "SAGE_LOCAL undefined ... exiting";
   echo "Maybe run 'sage -sh'?"
   exit 1
fi

if [ `uname` = "Darwin" -a "$SAGE64" = "yes" ]; then
   echo "Building 64 bit OSX version of Sage"
   CFLAGS="-O2 -g -m64 " && export CFLAGS
   LDFLAGS="-m64"
fi

cd src/

build()
{
    ./configure --prefix=$SAGE_LOCAL
    if [ `uname` == 'Darwin' ]; then
      if [ `uname -r | awk -F. '{ print $1; }'` == '9' ]; then
	echo "Fixing Makefile for OSX 10.5 compatibility"
	sed -e 's/-dynamic/-dynamiclib/' shlib/Makefile > shlib/Makefile.ok
	mv shlib/Makefile.ok shlib/Makefile
      fi
    fi
    make install
}

build

if [ $? -ne 0 ]; then
    echo "Error building and installing readline."
    exit 1
fi

if [ $UNAME = "Darwin" ]; then
  DYLIB_NAME=$SAGE_LOCAL/lib/libreadline.dylib
elif [ $UNAME = "CYGWIN" ]; then
  # It is of course very lame that readline names the file .dll.a, but that's what it does.
  DYLIB_NAME=$SAGE_LOCAL/lib/libreadline.dll.a
elif [ "$UNAME" = "OpenBSD" ]; then
  DYLIB_NAME=$SAGE_LOCAL/lib/libreadline.so.5.2
else
  DYLIB_NAME=$SAGE_LOCAL/lib/libreadline.so
fi

# Make sure that the install worked, despite whatever the error
# code of build was.
if [ -f $DYLIB_NAME -a -f $SAGE_LOCAL/lib/libreadline.a ]; then
  # Fix permissions.
  chmod 755 $SAGE_LOCAL/lib/libreadline.*
  chmod 755 $SAGE_LOCAL/lib/libhistory.*
  exit 0
else
  echo "Readline's build claims to have finished, but files that should have been built weren't."
  exit 1
fi
